!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).IndexdbStore=e()}(this,(function(){"use strict";function t(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,s)}return r}function e(e){for(var s=1;s<arguments.length;s++){var o=null!=arguments[s]?arguments[s]:{};s%2?t(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):t(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function r(t,e,r){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var s=r.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class s{constructor(t){r(this,"dbInfo",{name:"dbname",db:null,version:1,stores:[]}),this.dbInfo=t,this.init()}init(){return new Promise(((t,r)=>{const s=window.indexedDB.open(this.dbInfo.name,this.dbInfo.version);s.onsuccess=e=>{this.dbInfo.db=e.target.result,t(this.dbInfo.db)},s.onerror=t=>{r(t)},s.onupgradeneeded=t=>{let r;this.dbInfo.db=t.target.result,Array.isArray(this.dbInfo.stores)&&this.dbInfo.stores.forEach((t=>{const{storeName:s,indexs:o,mainKey:n}=t;this.dbInfo.db.objectStoreNames.contains(s)||(r=this.dbInfo.db.createObjectStore(s,{keyPath:n||"id"})),Array.isArray(o)&&o.forEach((t=>{try{r.createIndex(t.name,t.keyPath,e({unique:!1},t.params))}catch(t){console.error(t)}}))}))}}))}openDB(){return new Promise(((t,e)=>{const r=window.indexedDB.open(this.dbInfo.name,this.dbInfo.version);r.onsuccess=e=>{this.dbInfo.db=e.target.result,t(this.dbInfo.db)},r.onerror=t=>{e(t)}}))}addData(t,e){return new Promise(((r,s)=>{let o=this.dbInfo.db.transaction([t],"readwrite").objectStore(t).add(e);o.onsuccess=t=>{r(t)},o.onerror=t=>{throw new Error(t.target.error)}}))}getDataByKey(t,e){return new Promise(((r,s)=>{let o=this.dbInfo.db.transaction([t]).objectStore(t).get(e);o.onerror=t=>{s(t)},o.onsuccess=t=>{r(o.result)}}))}cursorGetData(t){let e=[],r=this.dbInfo.db.transaction(t,"readwrite").objectStore(t).openCursor();return new Promise(((t,s)=>{r.onsuccess=r=>{let s=r.target.result;s?(e.push(s.value),s.continue()):t(e)},r.onerror=t=>{s(t)}}))}cursorPage(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;return new Promise(((e,o)=>{let n=[],i=this.dbInfo.db.transaction([t],"readonly").objectStore(t),a=i.openCursor(),c=i.count(),d=null;a.onsuccess=t=>{let o=t.target.result;if(o){if(d===s-1){n.push(o.value);try{e({list:n,total:c.result})}catch(t){e({list:[],total:0})}return}null===d&&1!==r?(d=0,o.advance((r-1)*s)):(d++,n.push(o.value),o.continue())}else try{e({list:n,total:c.result})}catch(t){e({list:[],total:0})}},a.onerror=()=>{o("读取数据失败")}}))}getDataByIndex(t,e,r){let s=this.dbInfo.db.transaction(t,"readwrite").objectStore(t).index(e).get(r);return new Promise(((t,e)=>{s.onerror=t=>{e(t)},s.onsuccess=e=>{t(e.target.result)}}))}cursorGetDataByIndex(t,e){let r=[],s=this.dbInfo.db.transaction(t,"readwrite").objectStore(t);return new Promise(((o,n)=>{const{indexs:i}=this.dbInfo.stores.find((e=>e.storeName===t))||{};if(!i)return void o([]);let a="",c=[];for(const t in e)a+=","+t,c.push(e[t]);a=a.substring(1);const{name:d}=i.find((t=>t.keyPath===a))||{};if(!d)return void o([]);let u=s.index(d).openCursor(IDBKeyRange.only(1===c.length?c[0]:c));u.onsuccess=t=>{let e=t.target.result;e?(r.push(e.value),e.continue()):o(r)},u.onerror=t=>{n(t)}}))}updateDB(t,e){let r=this.dbInfo.db.transaction([t],"readwrite").objectStore(t).put(e);return new Promise(((t,e)=>{r.onsuccess=e=>{t(e)},r.onerror=e=>{t(e)}}))}deleteDB(t,e){let r=this.dbInfo.db.transaction([t],"readwrite").objectStore(t).delete(e);return new Promise(((t,e)=>{r.onsuccess=e=>{t(e)},r.onerror=e=>{t(e)}}))}deleteDBAll(t){let e=window.indexedDB.deleteDatabase(t);return new Promise(((t,r)=>{e.onerror=t=>{console.error(t)},e.onsuccess=t=>{console.info(t)}}))}closeDB(){this.dbInfo.db.close(),console.info("数据库已关闭")}}function o(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}function n(t){const e=[{key:"addtime",type:"desc"},...(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])||[]];let r=t;return e.forEach((t=>{let e,s;"string"==typeof t?(e="desc",s=t):"object"==typeof t&&(e="string"==typeof t.type?t.type.toLowerCase():"desc",s=t.key),"desc"===e?r=r.sort(((t,e)=>e[s]-t[s])):"asc"===e&&(r=r.sort(((t,e)=>t[s]-e[s])))})),r}function i(t,e){const r=t.find((t=>t.storeName===e));if(r)return r.mainKey||"id"}Date.prototype.Format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var r in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[r]:("00"+e[r]).substr((""+e[r]).length)));return t};return class{constructor(t){r(this,"name",null),r(this,"version",null),r(this,"stores",null),r(this,"db",null);let e="indexeddbname",s=1,o=[];t&&(e=t.name||e,s=t.version||s,o=t.stores||o),this.db||this.rebuild({name:e,version:s,stores:o})}rebuild(t){const{name:e,version:r,stores:o}=t||{};this.stores=o||this.stores,this.name=e||this.name,this.version=r||this.version,this.db=new s({name:e||this.name,version:r||this.version,db:null,stores:o||this.stores})}async addItem(t,r){let s=i(this.stores,t);if(!s)return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const n=new Date;try{const i=await this.db.addData(t,e(e({[s]:o()},r),{},{addtime:n.getTime(),addtimeformat:n.Format("yyyy-MM-dd hh:mm:ss")}));return this.db.closeDB(),{code:0,data:i}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}async addBatch(t,r){let s=i(this.stores,t);if(!s)return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(r)||0===r.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const n=new Date;let a=[];for(let i=0;i<r.length;i++){const c=r[i];try{const r=await this.db.addData(t,e(e({[s]:o()},c),{},{addtime:n.getTime(),addtimeformat:n.Format("yyyy-MM-dd hh:mm:ss")}));a.push({code:0,origin:c,data:r})}catch(t){a.push({code:-1,origin:c,data:t})}}return this.db.closeDB(),{code:0,data:a}}async updateItem(t,r){if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const s=new Date;try{const o=await this.db.updateDB(t,e(e({},r),{},{updatetime:s.getTime(),updatetimeformat:s.Format("yyyy-MM-dd hh:mm:ss")}));return this.db.closeDB(),{code:0,data:o}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}async updateBatch(t,r){if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(r)||0===r.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const s=new Date,o=[];for(let n=0;n<r.length;n++){const i=r[n];try{const r=await this.db.updateDB(t,e(e({},i),{},{updatetime:s.getTime(),updatetimeformat:s.Format("yyyy-MM-dd hh:mm:ss")}));o.push({code:0,data:r})}catch(t){o.push({code:-1,msg:t})}}return this.db.closeDB(),{code:0,data:o}}async delItem(t,e){if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}try{const r=await this.db.deleteDB(t,e);return this.db.closeDB(),{code:0,data:r}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}async delBatch(t,e){if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(e)||0===e.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const r=[];for(let s=0;s<e.length;s++)try{const o=await this.db.deleteDB(t,e[s]);r.push({code:0,data:o})}catch(t){r.push({code:-1,msg:t})}return this.db.closeDB(),{code:0,data:r}}async getAll(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}try{let r=await this.db.cursorGetData(t);return r=n(r,e),this.db.closeDB(),{code:0,data:r}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}async queryAll(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return void console.error(t)}const s=Object.keys(e||{}).length;try{let o;return o=s>0?await this.db.cursorGetDataByIndex(t,e):await this.db.cursorGetData(t),o=n(o,r),this.db.closeDB(),{code:0,data:o}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}async queryPage(t,e,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10;if(!i(this.stores,t))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(t)}catch(t){return{code:-1,msg:t}}const a=Object.keys(e||{}).length;try{let i;return i=a>0?await this.db.cursorGetDataByIndex(t,e):await this.db.cursorGetData(t),i=n(i,r),this.db.closeDB(),{code:0,data:{total:i.length,list:i.slice((s-1)*o,s*o)}}}catch(t){return this.db.closeDB(),{code:-1,msg:t}}}}}));
