!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("core-js/modules/es.regexp.exec.js"),require("core-js/modules/es.string.replace.js"),require("core-js/modules/es.regexp.to-string.js"),require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/es.array.sort.js"),require("core-js/modules/es.regexp.test.js"),require("core-js/modules/es.regexp.constructor.js"),require("core-js/modules/es.regexp.dot-all.js"),require("core-js/modules/es.promise.js"),require("core-js/modules/es.array.push.js"),require("core-js/modules/es.error.cause.js")):"function"==typeof define&&define.amd?define(["core-js/modules/es.regexp.exec.js","core-js/modules/es.string.replace.js","core-js/modules/es.regexp.to-string.js","core-js/modules/web.dom-collections.iterator.js","core-js/modules/es.array.sort.js","core-js/modules/es.regexp.test.js","core-js/modules/es.regexp.constructor.js","core-js/modules/es.regexp.dot-all.js","core-js/modules/es.promise.js","core-js/modules/es.array.push.js","core-js/modules/es.error.cause.js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndexdbStore=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function t(t){for(var s=1;s<arguments.length;s++){var o=null!=arguments[s]?arguments[s]:{};s%2?e(Object(o),!0).forEach((function(e){r(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function r(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class s{constructor(e){r(this,"dbInfo",{name:"dbname",db:null,version:1,stores:[]}),this.dbInfo=e,this.init()}init(){return new Promise(((e,r)=>{const s=window.indexedDB.open(this.dbInfo.name,this.dbInfo.version);s.onsuccess=t=>{this.dbInfo.db=t.target.result,e(this.dbInfo.db)},s.onerror=e=>{r(e)},s.onupgradeneeded=e=>{let r;this.dbInfo.db=e.target.result,Array.isArray(this.dbInfo.stores)&&this.dbInfo.stores.forEach((e=>{const{storeName:s,indexs:o,mainKey:n}=e;this.dbInfo.db.objectStoreNames.contains(s)||(r=this.dbInfo.db.createObjectStore(s,{keyPath:n||"id"})),Array.isArray(o)&&o.forEach((e=>{try{r.createIndex(e.name,e.keyPath,t({unique:!1},e.params))}catch(e){console.error(e)}}))}))}}))}openDB(){return new Promise(((e,t)=>{const r=window.indexedDB.open(this.dbInfo.name,this.dbInfo.version);r.onsuccess=t=>{this.dbInfo.db=t.target.result,e(this.dbInfo.db)},r.onerror=e=>{t(e)}}))}addData(e,t){return new Promise(((r,s)=>{let o=this.dbInfo.db.transaction([e],"readwrite").objectStore(e).add(t);o.onsuccess=e=>{r(e)},o.onerror=e=>{throw new Error(e.target.error)}}))}getDataByKey(e,t){return new Promise(((r,s)=>{let o=this.dbInfo.db.transaction([e]).objectStore(e).get(t);o.onerror=e=>{s(e)},o.onsuccess=e=>{r(o.result)}}))}cursorGetData(e){let t=[],r=this.dbInfo.db.transaction(e,"readwrite").objectStore(e).openCursor();return new Promise(((e,s)=>{r.onsuccess=r=>{let s=r.target.result;s?(t.push(s.value),s.continue()):e(t)},r.onerror=e=>{s(e)}}))}cursorPage(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;return new Promise(((t,o)=>{let n=[],i=this.dbInfo.db.transaction([e],"readonly").objectStore(e),a=i.openCursor(),c=i.count(),d=null;a.onsuccess=e=>{let o=e.target.result;if(o){if(d===s-1){n.push(o.value);try{t({list:n,total:c.result})}catch(e){t({list:[],total:0})}return}null===d&&1!==r?(d=0,o.advance((r-1)*s)):(d++,n.push(o.value),o.continue())}else try{t({list:n,total:c.result})}catch(e){t({list:[],total:0})}},a.onerror=()=>{o("读取数据失败")}}))}getDataByIndex(e,t,r){let s=this.dbInfo.db.transaction(e,"readwrite").objectStore(e).index(t).get(r);return new Promise(((e,t)=>{s.onerror=e=>{t(e)},s.onsuccess=t=>{e(t.target.result)}}))}cursorGetDataByIndex(e,t){let r=[],s=this.dbInfo.db.transaction(e,"readwrite").objectStore(e);return new Promise(((o,n)=>{const{indexs:i}=this.dbInfo.stores.find((t=>t.storeName===e))||{};if(!i)return void o([]);let a="",c=[];for(const e in t)a+=","+e,c.push(t[e]);a=a.substring(1);const{name:d}=i.find((e=>e.keyPath===a))||{};if(!d)return void o([]);let u=s.index(d).openCursor(IDBKeyRange.only(1===c.length?c[0]:c));u.onsuccess=e=>{let t=e.target.result;t?(r.push(t.value),t.continue()):o(r)},u.onerror=e=>{n(e)}}))}updateDB(e,t){let r=this.dbInfo.db.transaction([e],"readwrite").objectStore(e).put(t);return new Promise(((e,t)=>{r.onsuccess=t=>{e(t)},r.onerror=t=>{e(t)}}))}deleteDB(e,t){let r=this.dbInfo.db.transaction([e],"readwrite").objectStore(e).delete(t);return new Promise(((e,t)=>{r.onsuccess=t=>{e(t)},r.onerror=t=>{e(t)}}))}deleteDBAll(e){let t=window.indexedDB.deleteDatabase(e);return new Promise(((e,r)=>{t.onerror=e=>{console.error(e)},t.onsuccess=e=>{console.info(e)}}))}closeDB(){this.dbInfo.db.close(),console.info("数据库已关闭")}}function o(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function n(e){const t=[{key:"addtime",type:"desc"},...(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])||[]];let r=e;return t.forEach((e=>{let t,s;"string"==typeof e?(t="desc",s=e):"object"==typeof e&&(t="string"==typeof e.type?e.type.toLowerCase():"desc",s=e.key),"desc"===t?r=r.sort(((e,t)=>t[s]-e[s])):"asc"===t&&(r=r.sort(((e,t)=>e[s]-t[s])))})),r}function i(e,t){const r=e.find((e=>e.storeName===t));if(r)return r.mainKey||"id"}Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var r in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e};return class{constructor(e){r(this,"name",null),r(this,"version",null),r(this,"stores",null),r(this,"db",null),this.db||this.rebuild(e)}rebuild(e){const{name:t,version:r,stores:o}=e||{};this.stores=o||this.stores,this.name=t||this.name,this.version=r||this.version,this.db=new s({name:t||this.name,version:r||this.version,db:null,stores:o||this.stores})}async addItem(e,r){let s=i(this.stores,e);if(!s)return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const n=new Date;try{const i=await this.db.addData(e,t(t({[s]:o()},r),{},{addtime:n.getTime(),addtimeformat:n.Format("yyyy-MM-dd hh:mm:ss")}));return this.db.closeDB(),{code:0,data:i}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}async addBatch(e,r){let s=i(this.stores,e);if(!s)return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(r)||0===r.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const n=new Date;let a=[];for(let i=0;i<r.length;i++){const c=r[i];try{const r=await this.db.addData(e,t(t({[s]:o()},c),{},{addtime:n.getTime(),addtimeformat:n.Format("yyyy-MM-dd hh:mm:ss")}));a.push({code:0,origin:c,data:r})}catch(e){a.push({code:-1,origin:c,data:e})}}return this.db.closeDB(),{code:0,data:a}}async updateItem(e,r){if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const s=new Date;try{const o=await this.db.updateDB(e,t(t({},r),{},{updatetime:s.getTime(),updatetimeformat:s.Format("yyyy-MM-dd hh:mm:ss")}));return this.db.closeDB(),{code:0,data:o}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}async updateBatch(e,r){if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(r)||0===r.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const s=new Date,o=[];for(let n=0;n<r.length;n++){const i=r[n];try{const r=await this.db.updateDB(e,t(t({},i),{},{updatetime:s.getTime(),updatetimeformat:s.Format("yyyy-MM-dd hh:mm:ss")}));o.push({code:0,data:r})}catch(e){o.push({code:-1,msg:e})}}return this.db.closeDB(),{code:0,data:o}}async delItem(e,t){if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}try{const r=await this.db.deleteDB(e,t);return this.db.closeDB(),{code:0,data:r}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}async delBatch(e,t){if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};if(!Array.isArray(t)||0===t.length)return{code:-1,msg:"参数错误，批量添加参数应为一个非空列表"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const r=[];for(let s=0;s<t.length;s++)try{const o=await this.db.deleteDB(e,t[s]);r.push({code:0,data:o})}catch(e){r.push({code:-1,msg:e})}return this.db.closeDB(),{code:0,data:r}}async getAll(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}try{let r=await this.db.cursorGetData(e);return r=n(r,t),this.db.closeDB(),{code:0,data:r}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}async queryAll(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return void console.error(e)}const s=Object.keys(t||{}).length;try{let o;return o=s>0?await this.db.cursorGetDataByIndex(e,t):await this.db.cursorGetData(e),o=n(o,r),this.db.closeDB(),{code:0,data:o}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}async queryPage(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10;if(!i(this.stores,e))return{code:-1,msg:"表不存在，请检查您的配置"};try{await this.db.openDB(e)}catch(e){return{code:-1,msg:e}}const a=Object.keys(t||{}).length;try{let i;return i=a>0?await this.db.cursorGetDataByIndex(e,t):await this.db.cursorGetData(e),i=n(i,r),this.db.closeDB(),{code:0,data:{total:i.length,list:i.slice((s-1)*o,s*o)}}}catch(e){return this.db.closeDB(),{code:-1,msg:e}}}}}));
