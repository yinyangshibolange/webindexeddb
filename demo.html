<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDb demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/mhDoLbDldZc3qpsJHpLogda//BVZbgYuw6kof4u2FrCedxOtgRZDTHgHUhOCVim" crossorigin="anonymous"></script>
    <script src="./lib/bundle.umd.js"></script>
</head>
<body>
<div>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Active</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
            <a class="nav-link disabled">Disabled</a>
        </li>
    </ul>
    <div class="row">
        <div class="col card">
            <div id="data_demo" class=" ">
                <div class="title fs-3">demo数据表</div>
       <div class="d-flex">
           <input id="my_input"  class="form-control" type="text" placeholder="请输入数据" oninput="inputData()">
           <button  type="button" class="btn btn-primary" onclick="addOneDataItem()">添加一项并刷新</button>
       </div>
            </div>
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">Next</a></li>
                </ul>
            </nav>

        </div>
        <div class="col">
            <div id="file_demo" class="card">
                <div class="title fs-3">demo图片文件表</div>
                <input id="my_input_file"  class="form-control" type="file" multiple oninput="changeFile()">
            </div>
        </div>
    </div>




</div>
<script>
    var indexedStore = new IndexdbStore({
        name: "myindexdb", // 你的indexdb数据库名称
        version: 7, // 如果修改了options里的stores参数，那么必须修改version版本号，不然stores的修改不会生效
        stores: [
            { // 类似数据库表
                storeName: "demoStore",
                // mainKey: 'id', // 主键,默认为id
                // indexs: []
            },
            { // 类似数据库表
                storeName: "imageList",
                // mainKey: 'id', // 主键,默认为id
                indexs: [{
                    name: "parentid", // 索引名称
                    keyPath: "parentid", // 索引字段
                    params: {
                        unique: false,
                    }
                }]
            }
        ]
    })


    let my_data;

    function inputData() {
        const my_input = document.getElementById("my_input")
        my_data = my_input.value
    }


    async function addOneDataItem() {
        const res = await indexedStore.addItem('demoStore', {
            data: my_data,
            parentid: ''
        })
        if (res.code === 0) {
            queryPage()
        }
    }

    async function queryPage() {
        const page = 1
        const pagesize = 10
        const res = await indexedStore.queryPage('demoStore', null, null, page, pagesize)
        if (res.code === 0) {
            refreshList(res.data.list)
        }
    }

    queryPage()

    let data_demo_el = document.getElementById("data_demo")
    let my_table

    function refreshList(list) {
        if (my_table) {
            data_demo_el.removeChild(my_table)
            my_table = null
        }
        my_table = document.createElement("table")
        my_table.id = "my_table"
        my_table.classList.add("table")
        my_table.classList.add("table-striped")
        my_table.classList.add("table-hover")
        const thead = document.createElement("thead")
        const tr = document.createElement("tr")
        const th_id = document.createElement("th")
        const th_data = document.createElement("th")
        const th_addtimeformat = document.createElement("th")
        th_id.innerText = "编号"
        th_data.innerText = "数据"
        th_addtimeformat.innerText = "创建时间"
        tr.appendChild(th_id)
        tr.appendChild(th_data)
        tr.appendChild(th_addtimeformat)
        thead.appendChild(tr)
        my_table.appendChild(thead)

        const tbody = document.createElement("tbody")
        tbody.classList.add("table-group-divider")
        list.forEach(item => {
            const {id, data, addtimeformat} = item
            const tr = document.createElement("tr")
            const td_id = document.createElement("td")
            const td_data = document.createElement("td")
            const td_addtimeformat = document.createElement("td")
            td_id.innerText = id
            td_data.innerText = data
            td_addtimeformat.innerText = addtimeformat
            tr.appendChild(td_id)
            tr.appendChild(td_data)
            tr.appendChild(td_addtimeformat)
            tbody.appendChild(tr)
        })
        my_table.appendChild(tbody)
        data_demo_el.appendChild(my_table)
    }
</script>

<script>
    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader()
            reader.onload = function () {
                resolve({
                    url: reader.result,
                    name: file.name
                })
            }
            reader.readAsDataURL(file)
        })

    }

    async function changeFile() {
        const my_input_file = document.getElementById("my_input_file")
        const files = my_input_file.files

        let batchRef = []
        for (let i = 0; i < files.length; i++) {
            const fileRef = await readFile(files[i])
            batchRef.push(fileRef)
        }

        if (batchRef.length === 1) {
            addOneItem(batchRef[0])
        } else if (batchRef.length > 1) {
            addBatchItems(batchRef)
        }

    }


    async function addOneItem(item) {
        const res = await indexedStore.addItem('imageList', item)
        if (res.code === 0) {
            queryAll()
        }
    }

    async function addBatchItems(items) {
        const res = await indexedStore.addBatch('imageList', items)
        if (res.code === 0) {
            queryAll()
        }
    }


    let file_demo_el = document.getElementById("file_demo")
    let my_table_file

    async function queryAll() {
        const res = await indexedStore.queryAll('imageList', null, null,)
        if (res.code === 0) {
            createFileTable(res.data)
        }
    }

    queryAll()




    function createFileTable(list) {
        if (my_table_file) {
            file_demo_el.removeChild(my_table_file)
            my_table_file = null
        }
        my_table_file = document.createElement("table")
        my_table_file.id = "my_table_file"
        my_table_file.classList.add("table")
        my_table_file.classList.add("table-striped")
        my_table_file.classList.add("table-hover")

        const thead = document.createElement("thead")
        const tr = document.createElement("tr")
        const th_id = document.createElement("th")
        const th_data = document.createElement("th")
        const th_img = document.createElement("th")
        const th_addtimeformat = document.createElement("th")
        th_id.innerText = '编号'
        th_data.innerText = '名称'
        th_img.innerText = '图片'
        th_addtimeformat.innerText = '创建时间'
        tr.appendChild(th_id)
        tr.appendChild(th_data)
        tr.appendChild(th_img)
        tr.appendChild(th_addtimeformat)
        thead.appendChild(tr)
        my_table_file.appendChild(thead)
        const tbody = document.createElement("tbody")
        tbody.classList.add("table-group-divider")
        list.forEach(item => {
            const {id, name, addtimeformat, url} = item
            const tr = document.createElement("tr")
            const td_id = document.createElement("td")
            const td_data = document.createElement("td")
            const td_img = document.createElement("td")
            const td_addtimeformat = document.createElement("td")
            td_id.innerText = id
            td_data.innerText = name

            const img = document.createElement("img")
            img.src = url
            img.width = 100
            img.height = 100
            img.style.objectFit = 'cover'
            img.classList.add("rounded")

            td_img.appendChild(img)
            td_addtimeformat.innerText = addtimeformat
            tr.appendChild(td_id)
            tr.appendChild(td_data)
            tr.appendChild(td_img)
            tr.appendChild(td_addtimeformat)
            tbody.appendChild(tr)
        })
        my_table_file.appendChild(tbody)
        file_demo_el.appendChild(my_table_file)

    }
</script>
</body>
</html>
